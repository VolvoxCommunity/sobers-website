---
const navLinks = [
  { href: "/#features", label: "Features" },
  { href: "/#how-it-works", label: "How It Works" },
  { href: "/#faq", label: "FAQ" },
];
---

<header
  class="fixed top-0 left-0 right-0 z-50 backdrop-blur-header bg-theme/80 border-b border-theme"
>
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 group">
        <img src="/logo.png" alt="Sobers logo" class="w-8 h-8 rounded-lg object-contain" />
        <span
          class="font-bold text-lg text-primary-theme group-hover:text-primary transition-colors"
        >
          Sobers
        </span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="nav-link text-sm text-secondary-theme hover:text-primary transition-colors"
              data-nav-link={link.href.includes("#") ? link.href.split("#")[1] : ""}
            >
              {link.label}
            </a>
          ))
        }
      </div>

      <!-- Right Side: Theme Toggle + CTA -->
      <div class="flex items-center gap-4">
        <!-- Theme Toggle -->
        <button
          id="theme-toggle"
          type="button"
          class="p-2 rounded-lg text-secondary-theme hover:text-primary hover:bg-surface transition-all"
          aria-label="Toggle dark mode"
        >
          <!-- Sun icon (shown in dark mode) -->
          <svg
            class="w-5 h-5 hidden dark:block"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            ></path>
          </svg>
          <!-- Moon icon (shown in light mode) -->
          <svg
            class="w-5 h-5 block dark:hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            ></path>
          </svg>
        </button>

        <!-- Download CTA (Desktop) -->
        <a href="#download" class="hidden sm:inline-flex btn btn-primary text-sm">
          Download Free
        </a>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="md:hidden p-2 rounded-lg text-secondary-theme hover:text-primary hover:bg-surface transition-all"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden md:hidden pb-4 border-t border-theme mt-2 pt-4">
      <div class="flex flex-col gap-4">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="nav-link text-secondary-theme hover:text-primary transition-colors py-2"
              data-nav-link={link.href.includes("#") ? link.href.split("#")[1] : ""}
            >
              {link.label}
            </a>
          ))
        }
        <a href="#download" class="btn btn-primary text-sm w-full mt-2"> Download Free </a>
      </div>
    </div>
  </nav>
</header>

<script>
  // Theme Toggle
  const themeToggle = document.getElementById("theme-toggle");

  themeToggle?.addEventListener("click", () => {
    const isDark = document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  // Mobile Menu
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");

  mobileMenuBtn?.addEventListener("click", () => {
    const isExpanded = mobileMenuBtn.getAttribute("aria-expanded") === "true";
    mobileMenuBtn.setAttribute("aria-expanded", String(!isExpanded));
    mobileMenu?.classList.toggle("hidden");
  });

  // Close mobile menu on link click
  mobileMenu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      mobileMenu.classList.add("hidden");
      mobileMenuBtn?.setAttribute("aria-expanded", "false");
    });
  });

  // Scroll Spy - highlight nav links based on visible section
  const sections = document.querySelectorAll("section[id]");
  const navLinks = document.querySelectorAll("[data-nav-link]");

  function updateActiveNavLink() {
    const scrollPosition = window.scrollY + 100; // Offset for fixed header

    let currentSection = "";

    sections.forEach((section) => {
      const sectionTop = (section as HTMLElement).offsetTop;
      const sectionHeight = (section as HTMLElement).offsetHeight;

      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
        currentSection = section.getAttribute("id") || "";
      }
    });

    navLinks.forEach((link) => {
      const linkSection = link.getAttribute("data-nav-link");
      if (linkSection === currentSection) {
        link.classList.add("nav-link-active");
      } else {
        link.classList.remove("nav-link-active");
      }
    });
  }

  // Run on scroll with throttling for performance
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveNavLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Run on page load
  updateActiveNavLink();
</script>
