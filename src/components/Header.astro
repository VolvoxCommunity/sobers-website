---
import { APP_STORE_URL, PLAY_STORE_URL, WEB_APP_URL } from "@/constants/urls";

const navLinks = [
  { href: "/#hero", label: "Home" },
  { href: "/#features", label: "Features" },
  { href: "/#how-it-works", label: "How It Works" },
  { href: "/#faq", label: "FAQ" },
];

const downloadLinks = [
  {
    href: APP_STORE_URL,
    label: "iOS App",
    icon: "apple",
  },
  {
    href: PLAY_STORE_URL,
    label: "Android App",
    icon: "android",
  },
  {
    href: WEB_APP_URL,
    label: "Web App",
    icon: "web",
  },
];
---

<header
  class="fixed top-0 left-0 right-0 z-50 backdrop-blur-header bg-theme/80 border-b border-theme"
>
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 group">
        <img src="/logo.png" alt="Sobers logo" class="w-8 h-8 rounded-lg object-contain" />
        <span
          class="font-bold text-lg text-primary-theme group-hover:text-primary transition-colors"
        >
          Sobers
        </span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="nav-link text-sm text-secondary-theme hover:text-primary transition-colors"
              data-nav-link={link.href.includes("#") ? link.href.split("#")[1] : ""}
            >
              {link.label}
            </a>
          ))
        }
      </div>

      <!-- Right Side: Theme Toggle + CTA -->
      <div class="flex items-center gap-4">
        <!-- Theme Toggle -->
        <button
          id="theme-toggle"
          type="button"
          class="theme-toggle-btn p-2 rounded-lg text-secondary-theme hover:text-primary hover:bg-surface transition-all"
          aria-label="Toggle dark mode"
        >
          <!-- Sun icon (shown in dark mode) -->
          <svg
            class="theme-icon w-5 h-5 hidden dark:block"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            ></path>
          </svg>
          <!-- Moon icon (shown in light mode) -->
          <svg
            class="theme-icon w-5 h-5 block dark:hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            ></path>
          </svg>
        </button>

        <!-- Download CTA Dropdown (Desktop) -->
        <div class="hidden sm:block relative" id="download-dropdown">
          <button
            type="button"
            class="btn btn-primary text-sm inline-flex items-center gap-2"
            id="download-btn"
            aria-expanded="false"
            aria-haspopup="true"
          >
            Download Free
            <svg
              class="w-4 h-4 transition-transform duration-200"
              id="download-chevron"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div
            class="absolute right-0 mt-2 w-48 rounded-xl border border-theme bg-theme shadow-lg opacity-0 invisible transition-all duration-200 transform -translate-y-2"
            id="download-menu"
            role="menu"
          >
            {
              downloadLinks.map((link) => (
                <a
                  href={link.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-3 px-4 py-3 text-sm text-secondary-theme hover:text-primary hover:bg-surface/50 first:rounded-t-xl last:rounded-b-xl transition-colors"
                  role="menuitem"
                >
                  {link.icon === "apple" && (
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                    </svg>
                  )}
                  {link.icon === "android" && (
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M17.523 15.341a.96.96 0 0 0-.192 0h-.064a.96.96 0 1 0 .256 0zm-11.046 0a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm12.71-3.942l1.722-2.986a.357.357 0 0 0-.617-.357l-1.742 3.02A10.455 10.455 0 0 0 12 9.6a10.455 10.455 0 0 0-6.55 1.476L3.708 8.056a.357.357 0 0 0-.617.357l1.722 2.986C1.907 13.217 0 16.297 0 19.8h24c0-3.503-1.907-6.583-4.813-8.4zM6.477 17.261a.96.96 0 1 1 0-1.92.96.96 0 0 1 0 1.92zm11.046 0a.96.96 0 1 1 0-1.92.96.96 0 0 1 0 1.92z" />
                    </svg>
                  )}
                  {link.icon === "web" && (
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                      />
                    </svg>
                  )}
                  {link.label}
                </a>
              ))
            }
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="md:hidden p-2 rounded-lg text-secondary-theme hover:text-primary hover:bg-surface transition-all"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden md:hidden pb-4 border-t border-theme mt-2 pt-4">
      <div class="flex flex-col gap-4">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="nav-link text-secondary-theme hover:text-primary transition-colors py-2"
              data-nav-link={link.href.includes("#") ? link.href.split("#")[1] : ""}
            >
              {link.label}
            </a>
          ))
        }
        <!-- Mobile Download Links -->
        <div class="mt-2 pt-4 border-t border-theme">
          <p class="text-xs text-muted-theme mb-3 uppercase tracking-wider">Download</p>
          <div class="flex flex-col gap-2">
            {
              downloadLinks.map((link) => (
                <a
                  href={link.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-3 px-4 py-3 text-sm text-secondary-theme hover:text-primary bg-surface/50 rounded-lg transition-colors"
                >
                  {link.icon === "apple" && (
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                    </svg>
                  )}
                  {link.icon === "android" && (
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M17.523 15.341a.96.96 0 0 0-.192 0h-.064a.96.96 0 1 0 .256 0zm-11.046 0a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm12.71-3.942l1.722-2.986a.357.357 0 0 0-.617-.357l-1.742 3.02A10.455 10.455 0 0 0 12 9.6a10.455 10.455 0 0 0-6.55 1.476L3.708 8.056a.357.357 0 0 0-.617.357l1.722 2.986C1.907 13.217 0 16.297 0 19.8h24c0-3.503-1.907-6.583-4.813-8.4zM6.477 17.261a.96.96 0 1 1 0-1.92.96.96 0 0 1 0 1.92zm11.046 0a.96.96 0 1 1 0-1.92.96.96 0 0 1 0 1.92z" />
                    </svg>
                  )}
                  {link.icon === "web" && (
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                      />
                    </svg>
                  )}
                  {link.label}
                </a>
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  // Theme Toggle
  const themeToggle = document.getElementById("theme-toggle");

  themeToggle?.addEventListener("click", () => {
    const isDark = document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  // Mobile Menu
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");

  mobileMenuBtn?.addEventListener("click", () => {
    const isExpanded = mobileMenuBtn.getAttribute("aria-expanded") === "true";
    mobileMenuBtn.setAttribute("aria-expanded", String(!isExpanded));
    mobileMenu?.classList.toggle("hidden");
  });

  // Close mobile menu on link click
  mobileMenu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      mobileMenu.classList.add("hidden");
      mobileMenuBtn?.setAttribute("aria-expanded", "false");
    });
  });

  // Download Dropdown
  const downloadBtn = document.getElementById("download-btn");
  const downloadMenu = document.getElementById("download-menu");
  const downloadChevron = document.getElementById("download-chevron");

  function openDownloadMenu() {
    downloadMenu?.classList.remove("opacity-0", "invisible", "-translate-y-2");
    downloadMenu?.classList.add("opacity-100", "visible", "translate-y-0");
    downloadChevron?.classList.add("rotate-180");
    downloadBtn?.setAttribute("aria-expanded", "true");
  }

  function closeDownloadMenu() {
    downloadMenu?.classList.add("opacity-0", "invisible", "-translate-y-2");
    downloadMenu?.classList.remove("opacity-100", "visible", "translate-y-0");
    downloadChevron?.classList.remove("rotate-180");
    downloadBtn?.setAttribute("aria-expanded", "false");
  }

  downloadBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    const isExpanded = downloadBtn.getAttribute("aria-expanded") === "true";
    if (isExpanded) {
      closeDownloadMenu();
    } else {
      openDownloadMenu();
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    const dropdown = document.getElementById("download-dropdown");
    if (dropdown && !dropdown.contains(e.target as Node)) {
      closeDownloadMenu();
    }
  });

  // Close dropdown on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeDownloadMenu();
    }
  });

  // Scroll Spy - highlight nav links based on visible section
  const sections = document.querySelectorAll("section[id]");
  const navLinks = document.querySelectorAll("[data-nav-link]");

  // Get section IDs that have corresponding nav links
  const trackedSectionIds = new Set(
    Array.from(navLinks)
      .map((link) => link.getAttribute("data-nav-link"))
      .filter(Boolean)
  );

  function updateActiveNavLink() {
    const scrollPosition = window.scrollY + 150; // Offset for fixed header
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;

    // Check if at top of page (Home/Hero)
    if (scrollPosition < 200) {
      navLinks.forEach((link) => {
        const linkSection = link.getAttribute("data-nav-link");
        if (linkSection === "hero") {
          link.classList.add("nav-link-active");
        } else {
          link.classList.remove("nav-link-active");
        }
      });
      return;
    }

    // Check if at bottom of page - activate last section
    if (scrollPosition + windowHeight >= documentHeight - 100) {
      const lastTrackedSection = Array.from(sections)
        .filter((s) => trackedSectionIds.has(s.getAttribute("id")))
        .pop();

      if (lastTrackedSection) {
        const lastSectionId = lastTrackedSection.getAttribute("id");
        navLinks.forEach((link) => {
          const linkSection = link.getAttribute("data-nav-link");
          if (linkSection === lastSectionId) {
            link.classList.add("nav-link-active");
          } else {
            link.classList.remove("nav-link-active");
          }
        });
        return;
      }
    }

    // Find the last section that we've scrolled past
    let currentSection = "";

    sections.forEach((section) => {
      const sectionId = section.getAttribute("id");
      if (!sectionId || !trackedSectionIds.has(sectionId)) return;

      const sectionTop = (section as HTMLElement).offsetTop;

      if (scrollPosition >= sectionTop) {
        currentSection = sectionId;
      }
    });

    navLinks.forEach((link) => {
      const linkSection = link.getAttribute("data-nav-link");
      if (linkSection === currentSection) {
        link.classList.add("nav-link-active");
      } else {
        link.classList.remove("nav-link-active");
      }
    });
  }

  // Run on scroll with throttling for performance
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveNavLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Run on page load
  updateActiveNavLink();
</script>
