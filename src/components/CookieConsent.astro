---
/**
 * CookieConsent component for GDPR-compliant cookie consent management.
 * Uses vanilla-cookieconsent library with Google Consent Mode integration.
 * @see https://cookieconsent.orestbida.com/
 */
---

<script>
  import "vanilla-cookieconsent/dist/cookieconsent.css";
  import * as CookieConsent from "vanilla-cookieconsent";

  // Category constants
  const CAT_NECESSARY = "necessary";
  const CAT_ANALYTICS = "analytics";

  // Google Consent Mode service
  const SERVICE_ANALYTICS_STORAGE = "analytics_storage";

  // Define dataLayer and gtag function
  window.dataLayer = window.dataLayer || [];
  function gtag(...args: unknown[]) {
    window.dataLayer.push(args);
  }

  // Set default consent to 'denied' before any other dataLayer operations
  gtag("consent", "default", {
    ad_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    analytics_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    security_storage: "granted",
  });

  /**
   * Updates Google Tag consent based on CookieConsent user choices.
   */
  function updateGtagConsent() {
    const analyticsGranted = CookieConsent.acceptedCategory(CAT_ANALYTICS);

    gtag("consent", "update", {
      analytics_storage: analyticsGranted ? "granted" : "denied",
    });

    // Load Google Analytics if consent is granted
    if (analyticsGranted && !window.gaLoaded) {
      loadGoogleAnalytics();
    }
  }

  /**
   * Dynamically loads the Google Analytics script.
   */
  function loadGoogleAnalytics() {
    const GA_ID = "G-J4M348DW6C";
    const script = document.createElement("script");
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
    document.head.appendChild(script);

    gtag("js", new Date());
    gtag("config", GA_ID);

    window.gaLoaded = true;
  }

  // Initialize CookieConsent
  CookieConsent.run({
    // Core settings
    cookie: {
      name: "cc_cookie",
      expiresAfterDays: 182,
    },

    // UI settings
    guiOptions: {
      consentModal: {
        layout: "cloud inline",
        position: "bottom center",
        equalWeightButtons: true,
        flipButtons: false,
      },
      preferencesModal: {
        layout: "box",
        equalWeightButtons: true,
        flipButtons: false,
      },
    },

    // Callbacks for consent changes
    onFirstConsent: () => {
      updateGtagConsent();
    },
    onConsent: () => {
      updateGtagConsent();
    },
    onChange: () => {
      updateGtagConsent();
    },

    // Cookie categories
    categories: {
      [CAT_NECESSARY]: {
        enabled: true,
        readOnly: true,
      },
      [CAT_ANALYTICS]: {
        autoClear: {
          cookies: [{ name: /^_ga/ }, { name: "_gid" }],
        },
        services: {
          [SERVICE_ANALYTICS_STORAGE]: {
            label: "Google Analytics",
          },
        },
      },
    },

    // Language and translations
    language: {
      default: "en",
      autoDetect: "document",
      translations: {
        en: {
          consentModal: {
            title: "We value your privacy",
            description:
              'We use cookies to enhance your browsing experience and analyze site traffic. By clicking "Accept all", you consent to our use of cookies.',
            acceptAllBtn: "Accept all",
            acceptNecessaryBtn: "Reject all",
            showPreferencesBtn: "Manage preferences",
            footer: `
              <a href="/privacy">Privacy Policy</a>
              <a href="/terms">Terms of Service</a>
            `,
          },
          preferencesModal: {
            title: "Cookie Preferences",
            acceptAllBtn: "Accept all",
            acceptNecessaryBtn: "Reject all",
            savePreferencesBtn: "Save preferences",
            closeIconLabel: "Close modal",
            serviceCounterLabel: "Service|Services",
            sections: [
              {
                title: "Your Privacy Choices",
                description:
                  "In this panel you can manage your cookie preferences. You can review and change your choices at any time by reopening this panel via the cookie settings link in the footer.",
              },
              {
                title: "Strictly Necessary",
                description:
                  "These cookies are essential for the website to function properly and cannot be disabled. They are usually set in response to your actions like setting privacy preferences or logging in.",
                linkedCategory: CAT_NECESSARY,
              },
              {
                title: "Analytics",
                description:
                  "These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously.",
                linkedCategory: CAT_ANALYTICS,
                cookieTable: {
                  caption: "Analytics cookies",
                  headers: {
                    name: "Cookie",
                    domain: "Service",
                    description: "Description",
                    expiration: "Expiration",
                  },
                  body: [
                    {
                      name: "_ga",
                      domain: "Google Analytics",
                      description: "Used to distinguish users and sessions",
                      expiration: "2 years",
                    },
                    {
                      name: "_gid",
                      domain: "Google Analytics",
                      description: "Used to distinguish users",
                      expiration: "24 hours",
                    },
                  ],
                },
              },
              {
                title: "More information",
                description:
                  'For any questions about our cookie policy, please visit our <a href="/privacy">Privacy Policy</a> or <a href="/support">contact us</a>.',
              },
            ],
          },
        },
      },
    },
  });

  // Expose show preferences function globally for footer link
  (window as Window & { showCookiePreferences?: () => void }).showCookiePreferences = () => {
    CookieConsent.showPreferences();
  };
</script>
